<!doctype html>
<head><meta charset="utf8">
<title>Shared memory and atomics specification</title>
<link rel="stylesheet" href="https://bterlson.github.com/ecmarkup/elements.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">

</head><body><h1>Shared memory and atomics specification</h1>

<div><h2>Table of Contents</h2><ol class="toc"><li><a href="#intro"><span class="secnum"></span> Introduction</a></li><li><a href="#IndexedCollections"><span class="secnum">1</span> Indexed Collections (ES6 22)</a><ol class="toc"><li><a href="#TypedArray"><span class="secnum">1.1</span> TypedArray Objects (ES6 22.2)</a></li></ol></li><li><a href="#StructuredData"><span class="secnum">2</span> Structured Data (ES6 24)</a><ol class="toc"><li><a href="#SharedArrayBuffer"><span class="secnum">2.1</span> SharedArrayBuffer Objects (new)</a><ol class="toc"><li><a href="#SharedArrayBuffer_abstractOps"><span class="secnum">2.1.1</span> Abstract Operations for SharedArrayBuffer</a><ol class="toc"><li><a href="#AllocateSharedArrayBuffer"><span class="secnum">2.1.1.1</span> AllocateSharedArrayBuffer ( constructor, byteLength )</a></li></ol></li><li><a href="#SharedArrayBuffer_constructor"><span class="secnum">2.1.2</span> The SharedArrayBuffer Constructor</a><ol class="toc"><li><a href="#SharedArrayBuffer_constructorWithLength"><span class="secnum">2.1.2.1</span> SharedArrayBuffer ( length )</a></li></ol></li><li><a href="#SharedArrayBuffer_constructor_props"><span class="secnum">2.1.3</span> Properties of the SharedArrayBuffer constructor</a><ol class="toc"><li><a href="#SharedArrayBuffer.isView"><span class="secnum">2.1.3.1</span> SharedArrayBuffer.isView ( arg )</a></li><li><a href="#SharedArrayBuffer_prototype"><span class="secnum">2.1.3.2</span> SharedArrayBuffer.prototype</a></li><li><a href="#SharedArrayBuffer_getSpecies"><span class="secnum">2.1.3.3</span> get SharedArrayBuffer [ @@species ]</a></li></ol></li><li><a href="#SharedArrayBuffer_prototype_props"><span class="secnum">2.1.4</span> Properties of the SharedArrayBuffer prototype object</a><ol class="toc"><li><a href="#SharedArrayBuffer_prototype_get_byteLength"><span class="secnum">2.1.4.1</span> get SharedArrayBuffer.prototype.byteLength</a></li><li><a href="#SharedArrayBuffer_prototype_constructor"><span class="secnum">2.1.4.2</span> SharedArrayBuffer.prototype.constructor</a></li><li><a href="#SharedArrayBuffer_prototype_slice"><span class="secnum">2.1.4.3</span> SharedArrayBuffer.prototype.slice</a></li><li><a href="#SharedArrayBuffer_prototype_toString"><span class="secnum">2.1.4.4</span> SharedArrayBuffer.prototype[ @@toStringTag ]</a></li></ol></li><li><a href="#SharedArrayBuffer_instances"><span class="secnum">2.1.5</span> Properties of the SharedArrayBuffer instances</a></li></ol></li></ol></li><li><a href="#AtomicsObject"><span class="secnum">3</span> The Atomics Object (new)</a><ol class="toc"><li><a href="#AtomicsObjectValueProps"><span class="secnum">3.1</span> Value Properties of the Atomics Object</a><ol class="toc"><li><a href="#Atomics.OK"><span class="secnum">3.1.1</span> Atomics.OK</a></li><li><a href="#Atomics.NOTEQUAL"><span class="secnum">3.1.2</span> Atomics.NOTEQUAL</a></li><li><a href="#Atomics.TIMEDOUT"><span class="secnum">3.1.3</span> Atomics.TIMEDOUT</a></li></ol></li><li><a href="#AtomicsObjectFunctionProps"><span class="secnum">3.2</span> Function Properties of the Atomics Object</a><ol class="toc"><li><a href="#Atomics.add"><span class="secnum">3.2.1</span> Atomics.add ( ta, index, value )</a></li><li><a href="#Atomics.and"><span class="secnum">3.2.2</span> Atomics.and ( ta, index, value )</a></li><li><a href="#Atomics.compareExchange"><span class="secnum">3.2.3</span> Atomics.compareExchange ( ta, index, expectedValue, replacementValue )</a></li><li><a href="#Atomics.exchange"><span class="secnum">3.2.4</span> Atomics.exchange ( ta, index, value )</a></li><li><a href="#Atomics.futexWait"><span class="secnum">3.2.5</span> Atomics.futexWait ( ta, index, value, timeout )</a></li><li><a href="#Atomics.futexWake"><span class="secnum">3.2.6</span> Atomics.futexWake ( ta, index, count )</a></li><li><a href="#Atomics.futexWakeOrRequeue"><span class="secnum">3.2.7</span> Atomics.futexWakeOrRequeue ( ta, index1, count, index2, value )</a></li><li><a href="#Atomics.isLockFree"><span class="secnum">3.2.8</span> Atomics.isLockFree ( size )</a></li><li><a href="#Atomics.load"><span class="secnum">3.2.9</span> Atomics.load ( ta, index )</a></li><li><a href="#Atomics.or"><span class="secnum">3.2.10</span> Atomics.or ( ta, index, value )</a></li><li><a href="#Atomics.store"><span class="secnum">3.2.11</span> Atomics.store ( ta, index, value )</a></li><li><a href="#Atomics.sub"><span class="secnum">3.2.12</span> Atomics.sub ( ta, index, value )</a></li><li><a href="#Atomics.xor"><span class="secnum">3.2.13</span> Atomics.xor ( ta, index, value )</a></li></ol></li></ol></li></ol></div><emu-intro id="intro">
<h1><span class="secnum"></span>Introduction</h1>
<p>
This proposal adds shared memory types and atomic operations to ECMAScript.
</p>
<p>
This document is organized in terms of where changes would be made to the ES6 spec. Although ecmarkup generates numbering at the beginning of headers, these won't correspond to the numbering within the existing ECMA spec, so I've included a matching numbering in parentheses afterwards, referring to the ES6 spec.
</p>
<p>This document is in spec order, not written for direct readability.</p>
<p>Changelog:</p>
<ul>
</ul>
</emu-intro>

<emu-clause id="IndexedCollections">
  <h1><span class="secnum">1</span>Indexed Collections (ES6 22)</h1>
  <emu-clause id="TypedArray">
    <h1><span class="secnum">1.1</span>TypedArray Objects (ES6 22.2)</h1>
    <p>Modifications to TypedArray to allow the use of SharedArrayBuffer</p>
  </emu-clause>
</emu-clause>

<emu-clause id="StructuredData">
  <h1><span class="secnum">2</span>Structured Data (ES6 24)</h1>
  <emu-clause id="SharedArrayBuffer">
    <h1><span class="secnum">2.1</span>SharedArrayBuffer Objects (new)</h1>

    <emu-clause id="SharedArrayBuffer_abstractOps">
      <h1><span class="secnum">2.1.1</span>Abstract Operations for SharedArrayBuffer</h1>
      <emu-clause id="AllocateSharedArrayBuffer">
	<h1><span class="secnum">2.1.1.1</span>AllocateSharedArrayBuffer ( constructor, byteLength )</h1>
	<p> The abstract operation AllocateSharedArrayBuffer with arguments constructor and byteLength is used to create a SharedArrayBuffer object. It performs the following steps:</p>
	<p> FIXME </p>
      </emu-clause>
    </emu-clause>

    <emu-clause id="SharedArrayBuffer_constructor">
      <h1><span class="secnum">2.1.2</span>The SharedArrayBuffer Constructor</h1>
      <emu-clause id="SharedArrayBuffer_constructorWithLength">
	<h1><span class="secnum">2.1.2.1</span>SharedArrayBuffer ( length )</h1>
      </emu-clause>
    </emu-clause>

    <emu-clause id="SharedArrayBuffer_constructor_props">
      <h1><span class="secnum">2.1.3</span>Properties of the SharedArrayBuffer constructor</h1>
      <emu-clause id="SharedArrayBuffer.isView">
	<h1><span class="secnum">2.1.3.1</span>SharedArrayBuffer.isView ( arg )</h1>
	<p> FIXME </p>
      </emu-clause>
      <emu-clause id="SharedArrayBuffer_prototype">
	<h1><span class="secnum">2.1.3.2</span>SharedArrayBuffer.prototype</h1>
	<p> The initial value of ArrayBuffer.prototype is the intrinsic object %SharedArrayBufferPrototype% (q.v.).</p>
	<p> This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: false }.</p>
      </emu-clause>
      <emu-clause id="SharedArrayBuffer_getSpecies">
	<h1><span class="secnum">2.1.3.3</span>get SharedArrayBuffer [ @@species ]</h1>
	<p>SharedArrayBuffer[@@species] is an accessor property whose set accessor function is undefined. Its get accessor function performs the following steps:</p>
	<emu-alg><ol>
  <li>Return the this value.</li>
</ol></emu-alg>
	<p> The value of the name property of this function is "get [Symbol.species]".</p>
      </emu-clause>
    </emu-clause>

    <emu-clause id="SharedArrayBuffer_prototype_props">
      <h1><span class="secnum">2.1.4</span>Properties of the SharedArrayBuffer prototype object</h1>

      <emu-clause id="SharedArrayBuffer_prototype_get_byteLength">
	<h1><span class="secnum">2.1.4.1</span>get SharedArrayBuffer.prototype.byteLength</h1>
      </emu-clause>

      <emu-clause id="SharedArrayBuffer_prototype_constructor">
	<h1><span class="secnum">2.1.4.2</span>SharedArrayBuffer.prototype.constructor</h1>
      </emu-clause>

      <emu-clause id="SharedArrayBuffer_prototype_slice">
	<h1><span class="secnum">2.1.4.3</span>SharedArrayBuffer.prototype.slice</h1>
      </emu-clause>

      <emu-clause id="SharedArrayBuffer_prototype_toString">
	<h1><span class="secnum">2.1.4.4</span>SharedArrayBuffer.prototype[ @@toStringTag ]</h1>
      </emu-clause>
    </emu-clause>

    <emu-clause id="SharedArrayBuffer_instances">
      <h1><span class="secnum">2.1.5</span>Properties of the SharedArrayBuffer instances</h1>

      <p> SharedArrayBuffer instances inherit properties from the SharedArrayBuffer prototype object. SharedArrayBuffer instances each have an [[ArrayBufferData]] internal slot and an [[ArrayBufferByteLength]] internal slot. </p>

      <p> SharedArrayBuffer instances, unlike ArrayBuffer instances, are never detached. </p>
    </emu-clause>

  </emu-clause>
</emu-clause>

<emu-clause id="AtomicsObject">
  <h1><span class="secnum">3</span>The Atomics Object (new)</h1>
  
  <emu-clause id="AtomicsObjectValueProps">
    <h1><span class="secnum">3.1</span>Value Properties of the Atomics Object</h1>
    <emu-clause id="Atomics.OK">
      <h1><span class="secnum">3.1.1</span>Atomics.OK</h1>
      <p>The value 0.</p>
    </emu-clause>
    <emu-clause id="Atomics.NOTEQUAL">
      <h1><span class="secnum">3.1.2</span>Atomics.NOTEQUAL</h1>
      <p>The value -1.</p>
    </emu-clause>
    <emu-clause id="Atomics.TIMEDOUT">
      <h1><span class="secnum">3.1.3</span>Atomics.TIMEDOUT</h1>
      <p>The value -2.</p>
    </emu-clause>
  </emu-clause>
  
  <emu-clause id="AtomicsObjectFunctionProps">
    <h1><span class="secnum">3.2</span>Function Properties of the Atomics Object</h1>
    <emu-clause id="Atomics.add">
      <h1><span class="secnum">3.2.1</span>Atomics.add ( ta, index, value )</h1>
    </emu-clause>
    <emu-clause id="Atomics.and">
      <h1><span class="secnum">3.2.2</span>Atomics.and ( ta, index, value )</h1>
    </emu-clause>
    <emu-clause id="Atomics.compareExchange">
      <h1><span class="secnum">3.2.3</span>Atomics.compareExchange ( ta, index, expectedValue, replacementValue )</h1>
    </emu-clause>
    <emu-clause id="Atomics.exchange">
      <h1><span class="secnum">3.2.4</span>Atomics.exchange ( ta, index, value )</h1>
      <emu-alg><ol>
  <li>If <var>ta</var> is not a TypedArray that maps shared memory then throw a <emu-const>TypeError</emu-const> exception</li>
  <li>Let <var>B</var> be the base type of <var>ta</var></li>
  <li>Let <var>i</var> be <a href="https://people.mozilla.org/~jorendorff/es6-draft.html#sec-tolength">ToLength</a>( <var>index</var> )</li>
  <li>Let <var>v</var> be the result of coercing <var>value</var> to <var>B</var></li>
  <li>Let <var>A</var> be the value of the <emu-const>length</emu-const> property of <var>ta</var></li>
  <li>If <var>i</var> &gt;= <var>A</var> then:
    <ol>
      <li>Throw a <emu-const>RangeError</emu-const> exception</li>
    </ol>
  </li>
  <li>Atomically let <var>r</var> be <var>ta</var> [ <var>i</var> ] and store <var>v</var> in <var>ta</var> [ <var>i</var> ]</li>
  <li>Return <var>r</var></li>
</ol></emu-alg>
    </emu-clause>
    <emu-clause id="Atomics.futexWait">
      <h1><span class="secnum">3.2.5</span>Atomics.futexWait ( ta, index, value, timeout )</h1>
    </emu-clause>
    <emu-clause id="Atomics.futexWake">
      <h1><span class="secnum">3.2.6</span>Atomics.futexWake ( ta, index, count )</h1>
    </emu-clause>
    <emu-clause id="Atomics.futexWakeOrRequeue">
      <h1><span class="secnum">3.2.7</span>Atomics.futexWakeOrRequeue ( ta, index1, count, index2, value )</h1>
    </emu-clause>
    <emu-clause id="Atomics.isLockFree">
      <h1><span class="secnum">3.2.8</span>Atomics.isLockFree ( size )</h1>
    </emu-clause>
    <emu-clause id="Atomics.load">
      <h1><span class="secnum">3.2.9</span>Atomics.load ( ta, index )</h1>
    </emu-clause>
    <emu-clause id="Atomics.or">
      <h1><span class="secnum">3.2.10</span>Atomics.or ( ta, index, value )</h1>
    </emu-clause>
    <emu-clause id="Atomics.store">
      <h1><span class="secnum">3.2.11</span>Atomics.store ( ta, index, value )</h1>
    </emu-clause>
    <emu-clause id="Atomics.sub">
      <h1><span class="secnum">3.2.12</span>Atomics.sub ( ta, index, value )</h1>
    </emu-clause>
    <emu-clause id="Atomics.xor">
      <h1><span class="secnum">3.2.13</span>Atomics.xor ( ta, index, value )</h1>
    </emu-clause>
  </emu-clause>
</emu-clause>
</body>